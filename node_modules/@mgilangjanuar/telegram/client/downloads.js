"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.downloadProfilePhoto = exports._downloadPhoto = exports._downloadCachedPhotoSize = exports._downloadWebDocument = exports._downloadContact = exports._downloadDocument = exports.downloadMedia = exports.downloadFile = void 0;
const tl_1 = require("../tl");
const Utils_1 = require("../Utils");
const Helpers_1 = require("../Helpers");
const __1 = require("../");
// All types
const sizeTypes = ["w", "y", "d", "x", "c", "m", "b", "a", "s"];
// Chunk sizes for `upload.getFile` must be multiple of the smallest size
const MIN_CHUNK_SIZE = 4096;
const DEFAULT_CHUNK_SIZE = 64; // kb
const ONE_MB = 1024 * 1024;
const REQUEST_TIMEOUT = 15000;
const DISCONNECT_SLEEP = 1000;
/** @hidden */
async function downloadFile(client, inputLocation, fileParams) {
    const [value, release] = await client._semaphore.acquire();
    try {
        let { partSizeKb, end } = fileParams;
        const { fileSize, workers = 1 } = fileParams;
        const { dcId, progressCallback, start = 0 } = fileParams;
        if (end && fileSize) {
            end = end < fileSize ? end : fileSize - 1;
        }
        if (!partSizeKb) {
            partSizeKb = fileSize
                ? (0, Utils_1.getAppropriatedPartSize)(fileSize)
                : DEFAULT_CHUNK_SIZE;
        }
        const partSize = partSizeKb * 1024;
        const partsCount = end ? Math.ceil((end - start) / partSize) : 1;
        if (partSize % MIN_CHUNK_SIZE !== 0) {
            throw new Error(`The part size must be evenly divisible by ${MIN_CHUNK_SIZE}`);
        }
        client._log.info(`Downloading file in chunks of ${partSize} bytes`);
        const foreman = new Foreman(workers);
        const promises = [];
        let offset = start;
        // Used for files with unknown size and for manual cancellations
        let hasEnded = false;
        let progress = 0;
        if (progressCallback) {
            progressCallback(progress);
        }
        // Preload sender
        await client.getSender(dcId);
        // eslint-disable-next-line no-constant-condition
        while (true) {
            let limit = partSize;
            let isPrecise = false;
            if (Math.floor(offset / ONE_MB) !==
                Math.floor((offset + limit - 1) / ONE_MB)) {
                limit = ONE_MB - (offset % ONE_MB);
                isPrecise = true;
            }
            await foreman.requestWorker();
            if (hasEnded) {
                foreman.releaseWorker();
                break;
            }
            // eslint-disable-next-line no-loop-func
            promises.push((async (offsetMemo) => {
                // eslint-disable-next-line no-constant-condition
                while (true) {
                    let sender;
                    try {
                        sender = await client.getSender(dcId);
                        const result = await sender.send(new tl_1.Api.upload.GetFile({
                            location: inputLocation,
                            offset: offsetMemo,
                            limit,
                            precise: isPrecise || undefined,
                        }));
                        if (progressCallback) {
                            if (progressCallback.isCanceled) {
                                throw new Error("USER_CANCELED");
                            }
                            progress += 1 / partsCount;
                            progressCallback(progress);
                        }
                        if (!end && result.bytes.length < limit) {
                            hasEnded = true;
                        }
                        foreman.releaseWorker();
                        return result.bytes;
                    }
                    catch (err) {
                        if (sender && !sender.isConnected()) {
                            await (0, Helpers_1.sleep)(DISCONNECT_SLEEP);
                            continue;
                        }
                        else if (err instanceof __1.errors.FloodWaitError) {
                            await (0, Helpers_1.sleep)(err.seconds * 1000);
                            continue;
                        }
                        foreman.releaseWorker();
                        hasEnded = true;
                        throw err;
                    }
                }
            })(offset));
            offset += limit;
            if (end && offset > end) {
                break;
            }
        }
        const results = await Promise.all(promises);
        const buffers = results.filter(Boolean);
        const totalLength = end ? end + 1 - start : undefined;
        return Buffer.concat(buffers, totalLength);
    }
    finally {
        release();
    }
}
exports.downloadFile = downloadFile;
class Foreman {
    constructor(maxWorkers) {
        this.maxWorkers = maxWorkers;
        this.activeWorkers = 0;
    }
    requestWorker() {
        this.activeWorkers++;
        if (this.activeWorkers > this.maxWorkers) {
            this.deferred = createDeferred();
            return this.deferred.promise;
        }
        return Promise.resolve();
    }
    releaseWorker() {
        this.activeWorkers--;
        if (this.deferred && this.activeWorkers <= this.maxWorkers) {
            this.deferred.resolve();
        }
    }
}
function createDeferred() {
    let resolve;
    const promise = new Promise((_resolve) => {
        resolve = _resolve;
    });
    return {
        promise,
        resolve: resolve,
    };
}
/** @hidden */
async function downloadMedia(client, messageOrMedia, downloadParams) {
    let date;
    let media;
    if (messageOrMedia instanceof tl_1.Api.Message) {
        media = messageOrMedia.media;
    }
    else {
        media = messageOrMedia;
    }
    if (typeof media == "string") {
        throw new Error("not implemented");
    }
    if (media instanceof tl_1.Api.MessageMediaWebPage) {
        if (media.webpage instanceof tl_1.Api.WebPage) {
            media = media.webpage.document || media.webpage.photo;
        }
    }
    if (media instanceof tl_1.Api.MessageMediaPhoto || media instanceof tl_1.Api.Photo) {
        return _downloadPhoto(client, media, downloadParams);
    }
    else if (media instanceof tl_1.Api.MessageMediaDocument ||
        media instanceof tl_1.Api.Document) {
        return _downloadDocument(client, media, downloadParams);
    }
    else if (media instanceof tl_1.Api.MessageMediaContact) {
        return _downloadContact(client, media, downloadParams);
    }
    else if (media instanceof tl_1.Api.WebDocument ||
        media instanceof tl_1.Api.WebDocumentNoProxy) {
        return _downloadWebDocument(client, media, downloadParams);
    }
    else {
        return Buffer.alloc(0);
    }
}
exports.downloadMedia = downloadMedia;
/** @hidden */
async function _downloadDocument(client, doc, args) {
    if (doc instanceof tl_1.Api.MessageMediaDocument) {
        if (!doc.document) {
            return Buffer.alloc(0);
        }
        doc = doc.document;
    }
    if (!(doc instanceof tl_1.Api.Document)) {
        return Buffer.alloc(0);
    }
    let size = undefined;
    if (args.sizeType) {
        size = doc.thumbs ? pickFileSize(doc.thumbs, args.sizeType) : undefined;
        if (!size && doc.mimeType.startsWith("video/")) {
            return Buffer.alloc(0);
        }
        if (size &&
            (size instanceof tl_1.Api.PhotoCachedSize ||
                size instanceof tl_1.Api.PhotoStrippedSize)) {
            return _downloadCachedPhotoSize(size);
        }
    }
    return client.downloadFile(new tl_1.Api.InputDocumentFileLocation({
        id: doc.id,
        accessHash: doc.accessHash,
        fileReference: doc.fileReference,
        thumbSize: size ? size.type : "",
    }), {
        fileSize: size && !(size instanceof tl_1.Api.PhotoSizeEmpty)
            ? size instanceof tl_1.Api.PhotoSizeProgressive
                ? Math.max(...size.sizes)
                : size.size
            : doc.size,
        progressCallback: args.progressCallback,
        start: args.start,
        end: args.end,
        dcId: doc.dcId,
        workers: args.workers,
    });
}
exports._downloadDocument = _downloadDocument;
/** @hidden */
async function _downloadContact(client, media, args) {
    throw new Error("not implemented");
}
exports._downloadContact = _downloadContact;
/** @hidden */
async function _downloadWebDocument(client, media, args) {
    throw new Error("not implemented");
}
exports._downloadWebDocument = _downloadWebDocument;
function pickFileSize(sizes, sizeType) {
    if (!sizeType || !sizes || !sizes.length) {
        return undefined;
    }
    const indexOfSize = sizeTypes.indexOf(sizeType);
    let size;
    for (let i = indexOfSize; i < sizeTypes.length; i++) {
        size = sizes.find((s) => s.type === sizeTypes[i]);
        if (size && !(size instanceof tl_1.Api.PhotoPathSize)) {
            return size;
        }
    }
    return undefined;
}
/** @hidden */
function _downloadCachedPhotoSize(size) {
    // No need to download anything, simply write the bytes
    let data;
    if (size instanceof tl_1.Api.PhotoStrippedSize) {
        data = (0, Utils_1.strippedPhotoToJpg)(size.bytes);
    }
    else {
        data = size.bytes;
    }
    return data;
}
exports._downloadCachedPhotoSize = _downloadCachedPhotoSize;
/** @hidden */
async function _downloadPhoto(client, photo, args) {
    if (photo instanceof tl_1.Api.MessageMediaPhoto) {
        if (photo.photo instanceof tl_1.Api.PhotoEmpty || !photo.photo) {
            return Buffer.alloc(0);
        }
        photo = photo.photo;
    }
    if (!(photo instanceof tl_1.Api.Photo)) {
        return Buffer.alloc(0);
    }
    const size = pickFileSize(photo.sizes, args.sizeType || sizeTypes[0]);
    if (!size || size instanceof tl_1.Api.PhotoSizeEmpty) {
        return Buffer.alloc(0);
    }
    if (size instanceof tl_1.Api.PhotoCachedSize ||
        size instanceof tl_1.Api.PhotoStrippedSize) {
        return _downloadCachedPhotoSize(size);
    }
    return client.downloadFile(new tl_1.Api.InputPhotoFileLocation({
        id: photo.id,
        accessHash: photo.accessHash,
        fileReference: photo.fileReference,
        thumbSize: size.type,
    }), {
        dcId: photo.dcId,
        fileSize: size instanceof tl_1.Api.PhotoSizeProgressive
            ? Math.max(...size.sizes)
            : size.size,
        progressCallback: args.progressCallback,
    });
}
exports._downloadPhoto = _downloadPhoto;
/** @hidden */
async function downloadProfilePhoto(client, entity, fileParams) {
    let photo;
    if (typeof entity == "object" && "photo" in entity) {
        photo = entity.photo;
    }
    else {
        entity = await client.getEntity(entity);
        if ("photo" in entity) {
            photo = entity.photo;
        }
        else {
            throw new Error(`Could not get photo from ${entity ? entity.className : undefined}`);
        }
    }
    let dcId;
    let loc;
    if (photo instanceof tl_1.Api.UserProfilePhoto ||
        photo instanceof tl_1.Api.ChatPhoto) {
        dcId = photo.dcId;
        loc = new tl_1.Api.InputPeerPhotoFileLocation({
            peer: __1.utils.getInputPeer(entity),
            photoId: photo.photoId,
            big: fileParams.isBig,
        });
    }
    else {
        return Buffer.alloc(0);
    }
    return client.downloadFile(loc, {
        dcId,
        workers: 1,
    });
}
exports.downloadProfilePhoto = downloadProfilePhoto;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG93bmxvYWRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vZ3JhbWpzL2NsaWVudC9kb3dubG9hZHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsOEJBQTRCO0FBRTVCLG9DQUF1RTtBQUN2RSx3Q0FBbUM7QUFFbkMsMkJBQW9DO0FBcURwQyxZQUFZO0FBQ1osTUFBTSxTQUFTLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBRWhFLHlFQUF5RTtBQUN6RSxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUM7QUFDNUIsTUFBTSxrQkFBa0IsR0FBRyxFQUFFLENBQUMsQ0FBQyxLQUFLO0FBQ3BDLE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUM7QUFDM0IsTUFBTSxlQUFlLEdBQUcsS0FBSyxDQUFDO0FBQzlCLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO0FBRTlCLGNBQWM7QUFDUCxLQUFLLFVBQVUsWUFBWSxDQUM5QixNQUFzQixFQUN0QixhQUF3QyxFQUN4QyxVQUE4QjtJQUU5QixNQUFNLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxHQUFHLE1BQU0sTUFBTSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUMzRCxJQUFJO1FBQ0EsSUFBSSxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsR0FBRyxVQUFVLENBQUM7UUFDckMsTUFBTSxFQUFFLFFBQVEsRUFBRSxPQUFPLEdBQUcsQ0FBQyxFQUFFLEdBQUcsVUFBVSxDQUFDO1FBQzdDLE1BQU0sRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxHQUFHLENBQUMsRUFBRSxHQUFHLFVBQVUsQ0FBQztRQUN6RCxJQUFJLEdBQUcsSUFBSSxRQUFRLEVBQUU7WUFDakIsR0FBRyxHQUFHLEdBQUcsR0FBRyxR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